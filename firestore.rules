/**
 * This ruleset enforces a Role-Based Access Control (RBAC) model combined with
 * user ownership. Admins are granted broad read and management privileges, while
 * regular users (customers) have restricted access to their own data.
 *
 * Core Philosophy:
 * The security model is centered around a dedicated `/roles_admin` collection.
 * The existence of a user's UID as a document ID in this collection grants
 * them system-wide administrative privileges. All other users are treated as
 * customers with access scoped strictly to their own information.
 *
 * Data Structure:
 * - /roles_admin/{userId}: Defines which users are administrators.
 * - /customers/{customerId}: Stores customer-specific data, owned by the customer.
 * - /bookings/{bookingId}: A central collection of all bookings. Accessible to admins
 *   and the specific customer who created the booking.
 * - /contact_form_submissions/{submissionId}: A collection for public contact
 *   form entries, readable only by admins.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper Functions
    
    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }
    
    /**
     * Checks if the currently authenticated user's UID matches the provided userId.
     * This is the foundation of the user-ownership model.
     * @param userId The UID to check against the authenticated user.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
     * @description Manages all taxi bookings. Customers can create their own, and admins
     *   can manage all bookings.
     * @path /bookings/{bookingId}
     * @allow (create) An authenticated user creating a booking for themselves.
     * @deny (update) A customer trying to change the status of their own booking.
     * @principle Denormalizes `customerId` for efficient ownership checks and admin oversight.
     */
    match /bookings/{bookingId} {
      allow get: if isSignedIn() && isOwner(resource.data.customerId);
      allow list: if false;
      allow create: if isSignedIn() && isOwner(request.resource.data.customerId);
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores submissions from the public contact form. Anyone can create one,
     *   but only administrators can read or manage them.
     * @path /contact_form_submissions/{submissionId}
     * @allow (create) An anonymous website visitor submitting the contact form.
     * @deny (list) An authenticated but non-admin user trying to read all submissions.
     * @principle Segregates public-write data from private-read data.
     */
    match /contact_form_submissions/{submissionId} {
      allow get: if false;
      allow list: if false;
      allow create: if true;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Stores customer data. Each customer can manage their own document,
     *   and admins have read access for support purposes.
     * @path /customers/{customerId}
     * @allow (create) A new user signing up and creating their own customer profile.
     * @deny (list) Any user, including admins, attempting to list all customers to protect privacy.
     * @principle Enforces a strict path-based ownership model for user data.
     */
    match /customers/{customerId} {
      allow get: if isOwner(customerId);
      allow list: if false; // Disallow listing all customers for privacy
      allow create: if isOwner(customerId) && request.resource.data.id == customerId;
      allow update: if isOwner(customerId);
      allow delete: if isOwner(customerId);
    }

    /**
     * @description Stores user reviews. Authenticated users can submit a review.
     * @path /reviews/{reviewId}
     * @allow (create) An authenticated user can submit a review.
     */
    match /reviews/{reviewId} {
      allow get: if true; // Allow anyone to read reviews
      allow list: if true; // Allow anyone to list reviews
      allow create: if isSignedIn() && isOwner(request.resource.data.userId);
      allow update: if false;
      allow delete: if false;
    }
  }
}
